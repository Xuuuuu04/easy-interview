# Agent 深度优化与前端同步机制升级计划

针对您指出的 AI 计划调整能力、实时性和执行逻辑问题，我制定了以下深度优化方案：

## 1. 核心问题分析

* **同步延迟**：目前 `/api/chat` 接口先返回响应，再异步启动计划评估。这意味着用户听到的回答是基于“旧计划”生成的，且前端展示的计划状态会**滞后一轮**（只有在下一次请求时才会更新）。

* **能力受限**：Agent 只能“修改”或“完成”，无法“插入”新问题。这在需要深入追问（Pressure Test）时会导致原有计划被覆盖，不够灵活。

* **单次执行**：Agent 是一次性的（Single-turn），无法进行复杂的“思考-执行-再确认”循环。

## 2. 解决方案设计

### 🚀 优化点一：实现即时同步（Frontend Polling）

**目标**：让前端在 AI 说话时，就能实时看到计划项被打钩 ✅。

* **后端**：

  * 新增 API 端点 `GET /api/plan-status/{session_key}`，用于返回当前缓存中的最新计划。

* **前端**：

  * 在 `app.js` 中，当收到 `/api/chat` 响应后，启动一个短时的**轮询机制**（每 1.5 秒一次，持续 10 秒或直到检测到 `plan_updated: true`）。

  * 一旦轮询到计划变动（如某个 ID 变为 done），立即触发 UI 动画更新。

### 🧠 优化点二：增强 Agent 工具集（Dynamic Insertion）

**目标**：赋予 AI “追问”的能力，而不仅仅是按部就班。

* **后端 (`interview_service.py`)**：

  * 新增工具 `insert_followup_question`：允许 Agent 在当前 Pending Item 之后插入一个新的 Item（例如 ID 为 `2.1`），用于针对性追问，而不破坏原有计划结构。

  * 更新 Agent 的 System Prompt，教它何时使用插入工具（如：发现逻辑漏洞时）。

### 🔄 优化点三：改进执行时机与上下文

**目标**：确保 Agent 看到的上下文是最新的，且其决策能影响后续对话。

* **上下文优化**：目前 Agent 只看最后 4 轮对话。必须能看到所有的上下文，现在模型能力有这个水平

* **执行逻辑**：保持异步执行以保证响应速度，但通过上述的“轮询机制”来解决视觉上的滞后感。

## 3. 执行步骤

1. **后端修改**：

   * 在 `app/api/routes/interview.py` 添加 `get_plan_status` 接口。

   * 在 `app/services/interview_service.py` 中增加 `insert_followup_question` 工具定义及处理逻辑。

   * 调整 Agent Prompt 以支持新工具。
2. **前端修改**：

   * 修改 `app/static/app.js`，在 `sendAudioToAI` 收到回复后，开启 `pollPlanStatus` 定时器。

   * 实现平滑的列表插入动画。
3. **验证**：

   * 测试高难度模式下的追问插入功能。

   * 验证打钩动画是否在语音播放期间出现。

